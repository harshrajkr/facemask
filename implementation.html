<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Face Mask Detector</title>

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/unicons.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/owl.theme.default.min.css">

    <!-- MAIN STYLE -->
    <link rel="stylesheet" href="css/main.css">

    <script src="js/tfjs.js"></script>
    <script src="js/blazeface.js"></script>
    <link rel="stylesheet" href="css/implement.css">
</head>

<body>

    <!-- MENU -->
    <nav class="navbar navbar-expand-sm navbar-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="./images/logo.png" alt="logo" height="50px">
                Face Mask Detector
            </a>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a href="/index.html#about" class="nav-link"><span data-hover="About">About</span></a>
                        <svg viewBox="0 0 500 150" preserveAspectRatio="none">
                            <path fill="none"
                                d="M325,18C228.7-8.3,118.5,8.3,78,21C22.4,38.4,4.6,54.6,5.6,77.6c1.4,32.4,52.2,54,142.6,63.7 c66.2,7.1,212.2,7.5,273.5-8.3c64.4-16.6,104.3-57.6,33.8-98.2C386.7-4.9,179.4-1.4,126.3,20.7" />
                        </svg>
                    </li>
                    <li class="nav-item">
                        <a href="/index.html#project" class="nav-link"><span data-hover="Projects">Projects</span></a>
                        <svg viewBox="0 0 500 150" preserveAspectRatio="none">
                            <path fill="none"
                                d="M325,18C228.7-8.3,118.5,8.3,78,21C22.4,38.4,4.6,54.6,5.6,77.6c1.4,32.4,52.2,54,142.6,63.7 c66.2,7.1,212.2,7.5,273.5-8.3c64.4-16.6,104.3-57.6,33.8-98.2C386.7-4.9,179.4-1.4,126.3,20.7" />
                        </svg>
                    </li>
                    <li class="nav-item">
                        <a href="/index.html#process" class="nav-link"><span data-hover="Process">Process</span></a>
                        <svg viewBox="0 0 500 150" preserveAspectRatio="none">
                            <path fill="none"
                                d="M325,18C228.7-8.3,118.5,8.3,78,21C22.4,38.4,4.6,54.6,5.6,77.6c1.4,32.4,52.2,54,142.6,63.7 c66.2,7.1,212.2,7.5,273.5-8.3c64.4-16.6,104.3-57.6,33.8-98.2C386.7-4.9,179.4-1.4,126.3,20.7" />
                        </svg>
                    </li>
                </ul>

                <ul class="navbar-nav ml-lg-auto">
                    <div class="ml-lg-4">
                        <div class="color-mode d-lg-flex justify-content-center align-items-center">
                            <i class="color-mode-icon"></i>
                            Switch Mode
                        </div>
                    </div>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container ">
        <div class="row bg-light" style="height:480px;">
            <video id="video" playsinline class="border " style="margin:auto;display:inline-block;"></video>
            <canvas id="output" class="canvas-output"
                style="margin:auto;position:relative;top:-480px;left:10px"></canvas>
        </div>
    </div>
    <script>
        var model, mask_model, ctx, videoWidth, videoHeight, canvas;
        // const video = document.getElementById('video');
        // console.log(video)
        const state = {
            backend: 'webgl'
        };
        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({
                'audio': false,
                'video': { facingMode: 'user' },
            });
            video.srcObject = stream;
            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        }

        const renderPrediction = async () => {
            tf.engine().startScope()
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            //estimatefaces model takes in 4 parameter (1) video, returnTensors, flipHorizontal, and annotateBoxes
            const predictions = await model.estimateFaces(video, true, false, false);
            const offset = tf.scalar(127.5);
            //check if prediction length is more than 0
            if (predictions.length > 0) {
                //clear context

                for (let i = 0; i < predictions.length; i++) {
                    var text = ""
                    var start = predictions[i].topLeft.arraySync();
                    var end = predictions[i].bottomRight.arraySync();
                    var size = [end[0] - start[0], end[1] - start[1]];
                    if (videoWidth < end[0] && videoHeight < end[0]) {
                        console.log("image out of frame")
                        continue
                    }
                    var inputImage = tf.browser.fromPixels(video).toFloat()
                    inputImage = inputImage.sub(offset).div(offset);
                    inputImage = inputImage.slice([parseInt(start[1]), parseInt(start[0]), 0], [parseInt(size[1]), parseInt(size[0]), 3])
                    inputImage = inputImage.resizeBilinear([224, 224]).reshape([1, 224, 224, 3])
                    result = mask_model.predict(inputImage).dataSync()
                    result = Array.from(result)
                    ctx.beginPath()
                    if (result[1] > result[0]) {
                        //no mask on
                        ctx.strokeStyle = "red"
                        ctx.fillStyle = "red";
                        text = "No Mask: " + (result[1] * 100).toPrecision(3).toString() + "%";
                    } else {
                        //mask on
                        ctx.strokeStyle = "green"
                        ctx.fillStyle = "green";
                        text = "Mask: " + (result[0] * 100).toPrecision(3).toString() + "%";
                    }
                    ctx.lineWidth = "4"
                    ctx.rect(start[0], start[1], size[0], size[1])
                    ctx.stroke()
                    ctx.font = "bold 15pt sans-serif";
                    ctx.fillText(text, start[0] + 5, start[1] + 20)
                }
            }
            //update frame
            requestAnimationFrame(renderPrediction);
            tf.engine().endScope()
        };

        const setupPage = async () => {
            await tf.setBackend(state.backend);
            await setupCamera();
            video.play();

            videoWidth = video.videoWidth;
            videoHeight = video.videoHeight;
            video.width = videoWidth;
            video.height = videoHeight;

            canvas = document.getElementById('output');
            canvas.width = videoWidth;
            canvas.height = videoHeight;
            ctx = canvas.getContext('2d');
            ctx.fillStyle = "rgba(255, 0, 0, 0.5)";

            model = await blazeface.load();
            mask_model = await tf.loadLayersModel('./jsmodel/model.json');

            renderPrediction();
        };

        setupPage();

    </script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/Headroom.js"></script>
    <script src="js/jQuery.headroom.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/smoothscroll.js"></script>
    <script src="js/custom.js"></script>
</body>

</html>